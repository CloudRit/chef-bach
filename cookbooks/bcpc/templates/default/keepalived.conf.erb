################################################
#
#              Generated by Chef
#
################################################

global_defs {
  router_id controller-<%= "#{node[:bcpc][:node_number]}" %>
}

vrrp_script chk_haproxy {
  script "killall -0 haproxy"
  interval 2
}

vrrp_script chk_ceph {
  script "ceph --admin-daemon=/var/run/ceph/ceph-mon.<%="#{node.hostname}"%>.asok mon_status | grep state | grep -e 'leader\|peon'"
  interval 5
  fall 10
  rise 1
}

vrrp_instance <%= "BCPC_#{node[:bcpc][:region_name]}" %> {
  virtual_router_id <%="#{get_config('keepalived-router-id')}"%>

  # for electing MASTER, highest priority wins.
  priority  100
  state     BACKUP
  nopreempt

  interface <%= "#{node[:bcpc][:management][:interface]}" %>

  virtual_ipaddress {
    <%= "#{node[:bcpc][:management][:vip]}" %>
  }
  track_script {
    chk_haproxy
    chk_ceph
  }
  authentication {
    auth_type PASS
    auth_pass <%="#{get_config('keepalived-password')}"%>
  }
}
